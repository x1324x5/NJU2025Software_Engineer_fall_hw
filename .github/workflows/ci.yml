# 工作流名称
name: Ledger Project CI

# 触发条件：当代码推送到 main 或 master 分支，或者提交 Pull Request 时触发
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

# 定义任务
jobs:
  build-and-test:
    # 运行环境：使用最新版的 Ubuntu
    runs-on: ubuntu-latest

    steps:
    # 第一步：检出代码 (Checkout)
    # 这相当于把你的代码从 GitHub 下载到测试服务器上
    - name: Checkout repository
      uses: actions/checkout@v4

    # 第二步：设置 Python 环境
    # 我们使用 3.11，与你本地环境保持一致
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 第三步：安装依赖
    # 更新 pip 并安装 requirements.txt 中的库
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        # 再次确保安装了 pytest-cov，防止 requirements.txt 漏掉
        pip install pytest pytest-cov

    # 第四步：运行测试
    # 使用 python -m pytest 确保模块路径正确
    # 同时生成覆盖率报告（虽然 CI 不一定看报告，但这是好习惯）
    - name: Run tests with pytest
      run: |
        python -m pytest --cov=ledger tests/